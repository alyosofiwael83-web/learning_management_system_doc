<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5.4 تكامل النظام - نظام إدارة التعلم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-tomorrow.min.css">

    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --success: #2ecc71; --warning: #f39c12; --purple: #8e44ad; --light: #ecf0f1; --sidebar-width: 280px; --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275  ); --shadow: 0 10px 30px rgba(0, 0, 0, 0.1); --radius: 12px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f9f9f9; color: #333; display: flex; min-height: 100vh; direction: rtl; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(165deg, var(--primary) 0%, #1a2530 100%); color: white; height: 100vh; overflow-y: auto; box-shadow: var(--shadow); border-left: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
        .main-content { flex-grow: 1; overflow-y: auto; height: 100vh; background-color: white; }
        .content-page { max-width: 1100px; margin: 0 auto; padding: 60px 40px; color: #333; }
        .content-page h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 30px; text-align: center; position: relative; padding-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .content-page h1::after { content: ""; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100px; height: 4px; background: var(--secondary); border-radius: 2px; }
        .content-page > p { margin-bottom: 40px; font-size: 1.1rem; line-height: 1.8; text-align: justify; }
        .content-page h2 { color: var(--primary); margin: 50px 0 25px; font-size: 1.8rem; border-bottom: 2px solid var(--light); padding-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        
        /* --- تصميم رحلة السيناريو (Timeline) --- */
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            right: 29px; /* ليتمركز مع الأيقونات */
            height: 100%;
            width: 4px;
            background: var(--light);
            border-radius: 2px;
        }
        .timeline-item {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 20px;
            margin-bottom: 40px;
            position: relative;
        }
        .timeline-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            border: 4px solid #f9f9f9;
            box-shadow: 0 0 0 4px var(--primary);
            z-index: 1;
        }
        .timeline-content {
            background: #fff;
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        .timeline-content h3 {
            font-size: 1.5rem;
            margin: 0 0 15px 0;
        }
        .timeline-content p {
            margin: 0 0 20px 0;
            line-height: 1.7;
        }
        pre[class*="language-"] {
            margin: 0;
            border-radius: var(--radius);
            border: 1px solid #ddd;
            max-height: 300px;
        }

        /* --- ألوان مخصصة لكل دور --- */
        .timeline-item.student .timeline-icon { background-color: var(--purple); box-shadow-color: var(--purple); }
        .timeline-item.student .timeline-content h3 { color: var(--purple); }
        .timeline-item.system .timeline-icon { background-color: var(--primary); box-shadow-color: var(--primary); }
        .timeline-item.system .timeline-content h3 { color: var(--primary); }
        .timeline-item.doctor .timeline-icon { background-color: var(--success); box-shadow-color: var(--success); }
        .timeline-item.doctor .timeline-content h3 { color: var(--success); }

        .pagination { display: flex; justify-content: space-between; margin-top: 50px; padding-top: 30px; border-top: 1px solid #eee; }
        .btn { display: inline-flex; align-items: center; gap: 10px; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-weight: 600; transition: var(--transition); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-prev { background: var(--primary); color: white; }
        .btn-next { background: var(--secondary); color: white; }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    <main class="main-content">
        <section class="content-page">
            <h1><i class="fas fa-sitemap"></i> 5.4 تكامل النظام (System Integration)</h1>
            <p>بعد تنفيذ كل جزء من أجزاء النظام بشكل منفصل، تأتي المرحلة الأهم وهي ضمان تكامل هذه الأجزاء لتعمل معاً ككيان واحد متناغم. يوضح هذا القسم كيف تتدفق البيانات وتتفاعل العمليات عبر طبقات النظام المختلفة (الواجهة، المنطق، قاعدة البيانات) من خلال تتبع سيناريو واقعي.</p>

            <h2><i class="fas fa-route"></i> سيناريو: رحلة تسليم وتقييم واجب</h2>
            <p>سنقوم بتتبع رحلة تسليم واجب من قبل الطالب، مروراً بإشعار الدكتور، وانتهاءً بتقييم الواجب وإرسال إشعار بالدرجة للطالب.</p>

            <div class="timeline">
                <!-- الخطوة 1: الطالب يسلم الواجب -->
                <div class="timeline-item student">
                    <div class="timeline-icon"><i class="fas fa-user-graduate"></i></div>
                    <div class="timeline-content">
                        <h3>1. الطالب يقوم بالتسليم</h3>
                        <p>من خلال واجهة `StudentAssignmentsPage`، يقوم الطالب برفع ملف الحل والضغط على زر "تسليم". هذا يستدعي دالة `saveSubmission` في مكون Livewire.</p>
                        <pre><code class="language-php">
// StudentAssignmentsPage.php -> saveSubmission()

DB::transaction(function () use ($assignment) {
    $student = Auth::user()->student;
    $submission = Submission::updateOrCreate(
        ['assignment_id' => $this->assignment_id_to_submit, 'student_id' => $student->id],
        ['status' => 'submitted']
    );

    // ... حفظ الملفات ...
});
                        </code></pre>
                    </div>
                </div>

                <!-- الخطوة 2: النظام يرسل إشعاراً -->
                <div class="timeline-item system">
                    <div class="timeline-icon"><i class="fas fa-bell"></i></div>
                    <div class="timeline-content">
                        <h3>2. النظام يرسل إشعاراً للدكتور</h3>
                        <p>بعد نجاح عملية الحفظ في قاعدة البيانات، يقوم النظام فوراً بإنشاء وإرسال إشعار إلى الدكتور المسؤول عن المادة، لإعلامه بوجود تسليم جديد.</p>
                        <pre><code class="language-php">
// StudentAssignmentsPage.php -> saveSubmission()

if ($assignment->doctor?->user) {
    Notification::send(
        $assignment->doctor->user, 
        new NewSubmissionReceived($submission)
    );
}
                        </code></pre>
                    </div>
                </div>

                <!-- الخطوة 3: الدكتور يقوم بالتقييم -->
                <div class="timeline-item doctor">
                    <div class="timeline-icon"><i class="fas fa-user-doctor"></i></div>
                    <div class="timeline-content">
                        <h3>3. الدكتور يقوم بالتقييم</h3>
                        <p>في واجهة `DoctorAssignmentsPage`، يرى الدكتور التسليم الجديد. يقوم بفتح نموذج التقييم، يضع الدرجة والملاحظات، ثم يضغط "حفظ التقييم"، مما يستدعي دالة `saveGrade`.</p>
                        <pre><code class="language-php">
// DoctorAssignmentsPage.php -> saveGrade()

$submission->update([
    'grade' => $this->grade_value,
    'feedback' => $this->feedback_text,
    'status' => 'graded'
]);
                        </code></pre>
                    </div>
                </div>

                <!-- الخطوة 4: النظام يرسل إشعاراً للطالب -->
                <div class="timeline-item system">
                    <div class="timeline-icon"><i class="fas fa-bell"></i></div>
                    <div class="timeline-content">
                        <h3>4. النظام يرسل إشعاراً للطالب</h3>
                        <p>بعد حفظ التقييم، يقوم النظام بإرسال إشعار فوري إلى الطالب لإعلامه بأنه تم تقييم واجبه ويمكنه الاطلاع على الدرجة والملاحظات.</p>
                        <pre><code class="language-php">
// DoctorAssignmentsPage.php -> saveGrade()

if ($submission->student->user) {
    Notification::send(
        $submission->student->user, 
        new SubmissionGraded($submission)
    );
}
                        </code></pre>
                    </div>
                </div>
            </div>

            <nav class="pagination">
                <a href="5.3_ui_implementation.html" class="btn btn-prev"><i class="fas fa-arrow-right"></i> السابق: تنفيذ الواجهات</a>
                <a href="../chapter6/6.1_testing_methods.html" class="btn btn-next">التالي: أساليب الاختبار <i class="fas fa-arrow-left"></i></a>
            </nav>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-php.min.js"></script>
     <!-- الكود الموحد للجافاسكريبت -->
    <script>
        function setActiveLink() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                const linkPath = new URL(link.href, window.location.origin).pathname;
                if (currentPath.endsWith(linkPath.split('/').pop())) {
                    document.querySelectorAll('.nav-item.active, .submenu a.active').forEach(i => i.classList.remove('active'));
                    link.classList.add('active');
                    const parentNavItem = link.closest('.nav-item');
                    if (parentNavItem) {
                        parentNavItem.classList.add('active');
                    }
                }
            });
        }

        function initializeSidebarScripts() {
            document.querySelectorAll('.nav-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) { e.preventDefault(); this.parentElement.classList.toggle('active'); });
            });
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('active'); });
            }
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && sidebar?.classList.contains('active') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            fetch('../sidebar.html')
                .then(response => response.ok ? response.text() : Promise.reject('Failed to load sidebar'))
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    initializeSidebarScripts();
                    setActiveLink();
                })
                .catch(error => console.error('خطأ في تحميل الشريط الجانبي:', error));
        });
    </script>
</body>
</html>
